<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TODO: Fix the url -->
    <link rel="stylesheet" href="../main.css">
    <title>Spotifyer</title>
</head>

<body id="body">

    <img class="profile_picture">
    <h2 id="username"></h2>
    <h4>Top songs of the month</h4>
    <div id="main_body"></div>

    <!-- TODO: Share with friends -->
    <!-- <button class="share_button">Share with your friends!</button> -->

<script src="https://cdnjs.cloudflare.com/ajax/libs/color-thief/2.3.2/color-thief.min.js" integrity="sha512-mMe7BAZPOkGbq+zhRBMNV3Q+5ZDzcUEOJoUYXbHpEcODkDBYbttaW7P108jX66AQgwgsAjvlP4Ayb/XLJZfmsg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script>
        var colorThief = new ColorThief();

        let path = window.location.pathname;
        let pathArray = path.split("/")
        pathArray.splice(0, 2)

        console.log(pathArray)

        if (pathArray.length == 0) {
            // No user id
            window.location.href = "/";
        } else {
            const userid = pathArray.join("");

            // Fetch the user details
            fetch("/api/user/" + userid)
            .then(res => res.json())
            .then(d => {
                // Set profile_picture to image source
                document.getElementsByClassName("profile_picture")[0].src = d.images[0].url;
                document.getElementById("username").innerHTML = d.name;
            })

            fetch("/api/songs/" + userid)
                .then(res => {
                    if (res.ok) {
                        return res.json()
                    } else {
                        window.location.href = "/";
                    }
                })
                .then(data => {
                    data.items.forEach(d => {


                        const {
                            name,
                            artists,
                            external_urls: {
                                spotify: url
                            },
                            album: {
                                images: [bigImage]
                            }
                        } = d;


                        // console.log(name, artists, url, bigImage.url);

                        document.getElementById("main_body").innerHTML += `
        <div class="track">
                <img src=${bigImage.url} />
                <div class="track_info">
                    <a href="${url}">
                        <h4>
                            ${name}
                           </h4> 
                            </a>
                    <p>${artists.map(a => a.name).join(", ")}</p>
                </div>
        </div>
        `
                    })

                })
        }
    </script>
</body>

</html>