<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- TODO: Fix the url -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css"
        integrity="sha512-SfTiTlX6kk+qitfevl/7LibUOeJWlt9rbyDn92a1DqWOw9vWG2MFoays0sgObmWazO5BQPiFucnnEAjpAB+/Sw=="
        crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="../main.css">
    <title>Spotifyer</title>
</head>

<body id="body">

    <p class="my-5 text-sm text-center">
        This little web application is made by
        <a href="https://github.com/nabilridhwan" class="underline font-bold">Nabil Ridhwan</a>. Spotifyer is
         <a
            href="https://github.com/nabilridhwan/spotifyer" class="underline font-bold">open-sourced</a> 
        and will always be!
        </p>

        <div class="jumbotron my-10 flex flex-col items-center">

            <img class="profile_picture rounded-full w-24 h-24">

            <h2 id="username" class="text-3xl font-bold"></h2>
            <p class="text-sm text-black/50" id="follower-count-text">
            </p>


            <!-- Profile button -->
            <a id="spotify-profile-link"
                class="flex mt-6 justify-center items-center px-3 py-1 bg-spotify-green text-white rounded-lg shadow-spotify-green/50 shadow-md btn-anim">
                <i class="fa fa-spotify text-2xl text-center text-white mr-2" aria-hidden="true"></i>

                Spotify

            </a>
            </div>

            <div class="currently-listening my-20">
                <h5 class="text-center font-bold text-lg my-2 text-black/50">I'm currently listening to</h5>

                <!-- Currently Listening -->
                <a id="currently-listening-data-url" href="/api/auth">
                    <div id="currently-listening-song"
                        class="flex bg-white drop-shadow-bg w-fit rounded-lg m-auto items-center btn-anim">

                        <img id="currently-listening-data-img" class="h-14 rounded-tl-lg rounded-bl-lg">

                        <div class="mx-4">
                            <p id="currently-listening-data-title" class="font-bold"></p>
                            <p id="currently-listening-data-artist" class="text-black/50 text-sm"></p>
                        </div>

                    </div>

                </a>

            </div>

            <h4 class="text-center font-bold my-4">Top songs of the month</h4>
            <div id="top-tracks" class="flex flex-wrap"></div>

            <!-- TODO: Share with friends -->
            <!-- <button class="share_button">Share with your friends!</button> -->
            <script>
                let path = window.location.pathname;
                let pathArray = path.split("/")
                pathArray.splice(0, 2)

                console.log(pathArray)

                if (pathArray.length == 0) {
                    // No user id
                    window.location.href = "/users";
                } else {
                    const userid = pathArray.join("");

                    // Fetch the user details
                    fetch("/api/user/" + userid)
                        .then(res => res.json())
                        .then(d => {
                            // Set profile_picture to image source
                            if(!d.follower_count){
                                document.getElementById("follower-count-text").innerHTML = "This person is pretty mysterious! We can't see their followers on Spotify!"
                            }else{
                                document.getElementById("follower-count-text").innerHTML = d.follower_count + " followers on Spotify";
                            }

                            document.getElementsByClassName("profile_picture")[0].src = d.images[0].url;
                            document.getElementById("username").innerHTML = d.name;
                            document.getElementById("spotify-profile-link").href =
                                `https://open.spotify.com/user/${d.spotify_userid}`;
                        })

                    // Fetch currently playing
                    fetch("/api/songs/" + userid + "/currently_playing")
                        .then(res => {
                            if (!res.ok) {
                                throw new Error(res.statusText)
                            }
                            return res.json()
                        })
                        .then(data => {

                            let currently_playing_data = data.item;

                            if (data.item) {
                                let currently_playing_data_img = document.getElementById(
                                    "currently-listening-data-img");
                                let currently_playing_data_title = document.getElementById(
                                    "currently-listening-data-title");
                                let currently_playing_data_artist = document.getElementById(
                                    "currently-listening-data-artist");
                                let currently_playing_data_url = document.getElementById(
                                    "currently-listening-data-url");

                                currently_playing_data_img.src = currently_playing_data.album.images[0].url;
                                currently_playing_data_title.innerHTML = currently_playing_data.name;
                                currently_playing_data_artist.innerHTML = currently_playing_data.artists[0].name;
                                currently_playing_data_url.href = currently_playing_data.external_urls.spotify;
                            } else {
                                let currently_playing_data_url = document.getElementById(
                                    "currently-listening-data-url");
                                currently_playing_data_url.href = "#";

                                document.getElementById("currently-listening-song").innerHTML =
                                    "<p class='p-4 text-black/50 italic'>I'm not listening to anything right now</p>";
                            }

                        }).catch(error => {

                            let currently_playing_data_url = document.getElementById(
                            "currently-listening-data-url");
                            currently_playing_data_url.href = "#";

                            document.getElementById("currently-listening-song").innerHTML =
                                "<p class='p-4 text-black/50 italic'>Something went wrong! If you are the owner, try <a href='/api/auth' class='text-black/80'>logging in</a> again!</p>";
                        })

                    fetch("/api/songs/" + userid)
                        .then(res => {
                            if (res.ok) {
                                return res.json()
                            } else {
                                window.location.href = "/";
                            }
                        })
                        .then(data => {
                            data.items.forEach(d => {
                                const {
                                    name,
                                    artists,
                                    external_urls: {
                                        spotify: url
                                    },
                                    album: {
                                        images: [bigImage]
                                    }
                                } = d;


                                // console.log(name, artists, url, bigImage.url);

                                document.getElementById("top-tracks").innerHTML += `
                        <div class="group z-0 lg:w-1/5 w-1/2 md:w-1/3 btn-anim hover:z-50">
                             
                <img src=${bigImage.url}  class="w-fit h-auto"/>

                    <a href='${url}'>
                <div class="hidden group-hover:flex group-hover:flex-col group-hover:drop-shadow-bg absolute top-0 left-0 bg-black/50 w-full h-full justify-center items-center">

                <h1 class="text-white text-center font-bold">${name}</h1>
                <p class="text-white text-sm text-center">${artists[0].name}</p>

                </div>

                        </a>

                </div>
        `
                            })

                        })
                }
            </script>
</body>

</html>